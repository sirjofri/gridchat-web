#!/bin/rc

rfork

fn log{
	echo $* >[1=2]
}

fn sigkill{
	echo KILL >[1=2]
	test -d /proc/$catpid && echo kill >/proc/$catpid/note
	test -d /proc/$lstpid && echo kill >/proc/$lstpid/note
	sleep 1
	test -d /proc/$catpid && echo kill >/proc/$catpid/ctl
	test -d /proc/$lstpid && echo kill >/proc/$lstpid/ctl
	exit
}

log bind `{pwd}^/bin
bind -b `{pwd}^/bin /bin

ramfs
mkdir -p /tmp/www

if(! test -r /n/chat/chat){
	log /n/chat/chat not available!
	exit 'chat not available'
}
log cat chat buffer
cat /n/chat/chat > /tmp/www/chat.buf &
catpid=$apid

bind -a /n/chat /tmp/www

log running `{pwd}^/srv-http
aux/listen1 -t 'tcp!*!8080' `{pwd}^/srv-http &
lstpid=$apid

wait
