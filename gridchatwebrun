#!/bin/rc

rfork

fn log{
	echo $* >[1=2]
}

fn sigkill{
	echo KILL >[1=2]
	test -d /proc/$catpid && echo kill >/proc/$catpid/note
	test -d /proc/$lstpid && echo kill >/proc/$lstpid/note
	sleep 1
	test -d /proc/$catpid && echo kill >/proc/$catpid/ctl
	test -d /proc/$lstpid && echo kill >/proc/$lstpid/ctl
	exit
}

if(! test -r /n/chat/chat){
	log /n/chat/chat not available!
	exit 'chat not available'
}

log bind /bin
bind -b bin /bin

ramfs
mkdir -p /tmp/usr/web
mkdir -p /tmp/lib

cat <<. >/tmp/lib/namespace.httpd
.
bind /tmp/lib/namespace.httpd /lib/namespace.httpd

log cat chat buffer
cat /n/chat/chat > /tmp/usr/web/chat.buf &
catpid=$apid

bind -a www /tmp/usr/web
bind -a /n/chat /tmp/usr/web
bind /tmp/usr /usr

log running /bin/tcp80 -w
aux/listen1 -t 'tcp!*!8080' /bin/tcp80 -w &
lstpid=$apid

wait
